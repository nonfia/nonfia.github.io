<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Java 插件化注解处理介绍 Java 插件化注解处理是 JDK 1.6 实现 JSR-269 规范 Pluggable Annotations Processing API（插入式注解处理API）后提供给开发者的一系列 API Pluggable Annotation Processing API 的核心是 Annotation Proce"><title>Java 插件化注解处理</title>
<link rel=canonical href=/docs/java/standard/738504757867b1674d476019f08842fb/><link rel=stylesheet href=/scss/style.min.048e4000f12379bf8c9c4534ceedf6f43dcf4463a0aacde8cde5bc37fe392576.css><meta property='og:title' content="Java 插件化注解处理"><meta property='og:description' content="Java 插件化注解处理介绍 Java 插件化注解处理是 JDK 1.6 实现 JSR-269 规范 Pluggable Annotations Processing API（插入式注解处理API）后提供给开发者的一系列 API Pluggable Annotation Processing API 的核心是 Annotation Proce"><meta property='og:url' content='/docs/java/standard/738504757867b1674d476019f08842fb/'><meta property='og:site_name' content='Nonfia’s Blog'><meta property='og:type' content='article'><meta property='article:section' content='Docs'><meta property='article:tag' content='Java SE'><meta property='article:published_time' content='2024-11-22T00:00:00+00:00'><meta property='article:modified_time' content='2024-11-22T00:00:00+00:00'><meta property='og:image' content='https://picsum.photos/seed/738504757867b1674d476019f08842fb/800/600.webp'><meta name=twitter:title content="Java 插件化注解处理"><meta name=twitter:description content="Java 插件化注解处理介绍 Java 插件化注解处理是 JDK 1.6 实现 JSR-269 规范 Pluggable Annotations Processing API（插入式注解处理API）后提供给开发者的一系列 API Pluggable Annotation Processing API 的核心是 Annotation Proce"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://picsum.photos/seed/738504757867b1674d476019f08842fb/800/600.webp'><link rel="shortcut icon" href=/icon/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huc6e45365264693d385c1472ca36d8605_33272_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Nonfia’s Blog</a></h1><h2 class=site-description>记录编程之旅，分享代码智慧</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>档案</span></a></li><li><a href=/page/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#java-插件化注解处理介绍>Java 插件化注解处理介绍</a></li><li><a href=#注解处理器>注解处理器</a><ol><li><a href=#核心方法介绍>核心方法介绍</a></li></ol></li><li><a href=#自定义注解处理器>自定义注解处理器</a><ol><li><a href=#环境配置>环境配置</a></li><li><a href=#定义注解>定义注解</a></li><li><a href=#编写注解处理器>编写注解处理器</a></li><li><a href=#注册注解处理器>注册注解处理器</a><ol><li><a href=#手动配置>手动配置</a></li><li><a href=#自动配置>自动配置</a></li></ol></li></ol></li><li><a href=#测试>测试</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/docs/java/standard/738504757867b1674d476019f08842fb/><img src=https://picsum.photos/seed/738504757867b1674d476019f08842fb/800/600.webp loading=lazy alt="Featured image of post Java 插件化注解处理"></a></div><div class=article-details><header class=article-category><a href=/categories/java/ style=background-color:#57b5ff;color:#fff>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/docs/java/standard/738504757867b1674d476019f08842fb/>Java 插件化注解处理</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 22, 2024</time></div></footer></div></header><section class=article-content><h2 id=java-插件化注解处理介绍>Java 插件化注解处理介绍</h2><p>Java 插件化注解处理是 JDK 1.6 实现 JSR-269 规范 <strong>Pluggable Annotations Processing API</strong>（插入式注解处理API）后提供给开发者的一系列 API</p><p><strong>Pluggable Annotation Processing API</strong> 的核心是 <strong>Annotation Processor</strong>（注解处理器），JSR 269 定义了一种服务提供者接口（SPI），允许开发者创建自己的注解处理器</p><p>这些处理器可以在编译时被调用，以便检查、处理注解，并根据这些注解生成额外的源代码或其他文件。这种机制允许开发者在不改变原有代码逻辑的情况下，通过注解来引入新的行为或数据</p><h2 id=注解处理器>注解处理器</h2><p>注解编译期处理流程最关键的一个类就是 <strong>Processor</strong>，它是注解处理器的接口类，我们所有需要对编译期处理注解的逻辑都需要实现 <strong>Processor</strong> 接口。当然，<strong>AbstractProcessor</strong> 抽象类帮我们写好了大部分都流程，所以我们只需要实现这个抽象类就可以很方便的定义一个注解处理器</p><p>注解处理流程由多轮完成，每执行一次 <strong>process()</strong> 方法被称为一轮。每一轮都从编译器在源文件中搜索 <strong>注解</strong> 并选择适合这些注解的 <strong>注解处理器</strong> 开始，每个注解处理器依次在相应的源上被调用。
如果在执行此过程中产生了新代码，则将以生成的文件作为输入开始新一轮。这个过程一直持续到处理阶段没有新代码产生为止</p><p><strong>AbstractProcessor</strong> 是注解处理器的核心抽象类</p><h3 id=核心方法介绍>核心方法介绍</h3><p><strong>init</strong> 可以让我们在处理器的初始化阶段，通过 <strong>ProcessingEnvironment</strong> 来获取一些操作语法树需要的对象</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>processingEnv</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>getSupportedAnnotationTypes</strong> 指定需要处理的注解集合，默认从 <strong>@SupportedAnnotationTypes</strong> 中读取</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getSupportedAnnotationTypes</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><p><strong>@SupportedAnnotationTypes</strong> 使用，指定注解 <strong>com.brainy.nonfia.apt.annotation.Log</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>SupportedAnnotationTypes</span><span class=p>(</span><span class=s2>&#34;com.brainy.nonfia.apt.annotation.Log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>LogProcessor</span> <span class=k>extends</span> <span class=n>AbstractProcessor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>getSupportedSourceVersion</strong> 获取该注解处理器最大支持的版本，默认从 <strong>@SupportedSourceVersion</strong> 中读取</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>SourceVersion</span><span class=w> </span><span class=nf>getSupportedSourceVersion</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><p><strong>@SupportedSourceVersion</strong> 使用，指定版本 <strong>SourceVersion.RELEASE_17</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SupportedSourceVersion</span><span class=p>(</span><span class=n>SourceVersion</span><span class=p>.</span><span class=na>RELEASE_17</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DemoProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>process</strong> 是注解处理器核心方法，注解的处理和生成代码或者配置资源都是在这个方法中完成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TypeElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotations</span><span class=p>,</span><span class=w> </span><span class=n>RoundEnvironment</span><span class=w> </span><span class=n>roundEnv</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>process</strong> 方法提供了两个参数，第一个是我们请求处理注解类型的集合（ getSupportedAnnotationTypes 方法所返回的注解类型），第二个是有关当前和上一次循环的信息的环境。返回值表示这些注解是否由此处理器声明</p><p>如果返回 true，则这些注解不会被后续处理器处理<br>如果返回 false，则这些注解可以被后续的处理器处理</p><h2 id=自定义注解处理器>自定义注解处理器</h2><p>目的：根据注解自动生成 getter/setter 以及引入日志</p><h3 id=环境配置>环境配置</h3><p>在我们原有类中新增信息需要修改修改 <strong>抽象语法树（AST）</strong>，主要依靠 <strong>com.sun.tools</strong> 来操作</p><p>JDK 1.8 可以通过引入 tools.jar 来实现访问 com.sun.tools 包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>com.sun<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>tools<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>1.8<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;scope&gt;</span>system<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;systemPath&gt;</span>${java.home}/../lib/tools.jar<span class=nt>&lt;/systemPath&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>JDK 1.9 开始引入模块系统，需要自定义编译选项通过 <strong>&ndash;add-exports</strong> 来引入</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;compilerArgs&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>--add-exports=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/compilerArgs&gt;</span>
</span></span></code></pre></div><h3 id=定义注解>定义注解</h3><p>定义 @Getter、@Setter、 @Log 三个注解，分别用来控制生成 getter/setter 以及引入日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Getter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Setter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Log</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=编写注解处理器>编写注解处理器</h3><p>定义一个抽象类 AbstractAnnotationProcessor 继承 AbstractProcessor，重写 init 和 getSupportedSourceVersion 方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>AbstractAnnotationProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 解包装 ProcessingEnvironment 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>unwrappedProcessingEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 编译时期输入日志的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Messager</span><span class=w> </span><span class=n>messager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将Element转换为JCTree的工具,提供了待处理的抽象语法树</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>JavacTrees</span><span class=w> </span><span class=n>javacTrees</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 封装了创建AST节点的一些方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>TreeMaker</span><span class=w> </span><span class=n>treeMaker</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 提供了创建标识符的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Names</span><span class=w> </span><span class=n>names</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 支持 JDK 版本
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SourceVersion</span><span class=w> </span><span class=nf>getSupportedSourceVersion</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>SourceVersion</span><span class=p>.</span><span class=na>latestSupported</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 初始化一些操作语法树需要的对象
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param processingEnv environment to access facilities the tool framework
</span></span></span><span class=line><span class=cl><span class=cm>     *                      provides to the processor
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>processingEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>processingEnv</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>unwrappedProcessingEnv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jbUnwrap</span><span class=p>(</span><span class=n>processingEnv</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>messager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unwrappedProcessingEnv</span><span class=p>.</span><span class=na>getMessager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>javacTrees</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JavacTrees</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>unwrappedProcessingEnv</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>JavacProcessingEnvironment</span><span class=p>)</span><span class=w> </span><span class=n>unwrappedProcessingEnv</span><span class=p>).</span><span class=na>getContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>treeMaker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TreeMaker</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>names</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Names</span><span class=p>.</span><span class=na>instance</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * IntelliJ IDEA 解包装 ProcessingEnvironment 对象，返回原始的 ProcessingEnvironment 对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=nf>jbUnwrap</span><span class=p>(</span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>wrapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessingEnvironment</span><span class=w> </span><span class=n>unwrapped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>apiWrappers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>wrapper</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getClassLoader</span><span class=p>().</span><span class=na>loadClass</span><span class=p>(</span><span class=s>&#34;org.jetbrains.jps.javac.APIWrappers&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>unwrapMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>apiWrappers</span><span class=p>.</span><span class=na>getDeclaredMethod</span><span class=p>(</span><span class=s>&#34;unwrap&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unwrapped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ProcessingEnvironment</span><span class=p>)</span><span class=w> </span><span class=n>unwrapMethod</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>ProcessingEnvironment</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>wrapper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ignored</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unwrapped</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>unwrapped</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>wrapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 变量处理程序
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param element  使用给定注解类型注解的元素
</span></span></span><span class=line><span class=cl><span class=cm>     * @param func 特定执行函数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>variableHandler</span><span class=p>(</span><span class=n>Element</span><span class=w> </span><span class=n>element</span><span class=p>,</span><span class=w> </span><span class=n>BiFunction</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=p>,</span><span class=w> </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>func</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>javacTrees</span><span class=p>.</span><span class=na>getTree</span><span class=p>(</span><span class=n>element</span><span class=p>).</span><span class=na>accept</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TreeTranslator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>visitClassDef</span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=w> </span><span class=n>classDecl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=o>&gt;</span><span class=w> </span><span class=n>variableDecls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 找到定义的相关变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>JCTree</span><span class=w> </span><span class=n>jcTree</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>jcTree</span><span class=p>.</span><span class=na>getKind</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>Tree</span><span class=p>.</span><span class=na>Kind</span><span class=p>.</span><span class=na>VARIABLE</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>jcVariableDecl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=p>)</span><span class=w> </span><span class=n>jcTree</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Modifier</span><span class=o>&gt;</span><span class=w> </span><span class=n>modifierSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jcVariableDecl</span><span class=p>.</span><span class=na>getModifiers</span><span class=p>().</span><span class=na>getFlags</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>modifierSet</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>Modifier</span><span class=p>.</span><span class=na>FINAL</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>modifierSet</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>Modifier</span><span class=p>.</span><span class=na>STATIC</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>variableDecls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>variableDecls</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>jcVariableDecl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 对定义的相关变量执行相应方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>variableDecls</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>func</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>classDecl</span><span class=p>,</span><span class=w> </span><span class=n>item</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>super</span><span class=p>.</span><span class=na>visitClassDef</span><span class=p>(</span><span class=n>classDecl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 字符串转字段访问链
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param components 字符串
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=nf>strToJCFieldAccessChain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>components</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>componentArray</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>components</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;\\.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpression</span><span class=w> </span><span class=n>expr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Ident</span><span class=p>(</span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=n>componentArray</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>componentArray</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>expr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=n>expr</span><span class=p>,</span><span class=w> </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=n>componentArray</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>expr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 编译期打印输出
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg 输出信息
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>print</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>messager</span><span class=p>.</span><span class=na>printMessage</span><span class=p>(</span><span class=n>Diagnostic</span><span class=p>.</span><span class=na>Kind</span><span class=p>.</span><span class=na>NOTE</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写 @Getter 对应的注解处理器 GetterProcessor，继承刚定义的抽象类 AbstractAnnotationProcessor，重写 getSupportedAnnotationTypes 和 process 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GetterProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAnnotationProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getSupportedAnnotationTypes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Set</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Getter</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TypeElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotations</span><span class=p>,</span><span class=w> </span><span class=n>RoundEnvironment</span><span class=w> </span><span class=n>roundEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>roundEnv</span><span class=p>.</span><span class=na>getElementsAnnotatedWith</span><span class=p>(</span><span class=n>Getter</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>forEach</span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>variableHandler</span><span class=p>(</span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>::</span><span class=n>makeGetMethodDecl</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * GET 方法生成
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param classDecl    定义的类
</span></span></span><span class=line><span class=cl><span class=cm>     * @param variableDecl 定义的变量
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=o>&gt;</span><span class=w> </span><span class=nf>makeGetMethodDecl</span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=w> </span><span class=n>classDecl</span><span class=p>,</span><span class=w> </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>variableDecl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ListBuffer</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCStatement</span><span class=o>&gt;</span><span class=w> </span><span class=n>statements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ListBuffer</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 构建 return this.variableName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCReturn</span><span class=w> </span><span class=n>aReturn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Return</span><span class=p>(</span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Ident</span><span class=p>(</span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;this&#34;</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>statements</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>aReturn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCBlock</span><span class=w> </span><span class=n>block</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Block</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>statements</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>variableName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 构建方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCMethodDecl</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>MethodDef</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Modifiers</span><span class=p>(</span><span class=n>Flags</span><span class=p>.</span><span class=na>PUBLIC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;get&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>variableName</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>).</span><span class=na>toUpperCase</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>variableName</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>1</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>vartype</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>block</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加方法到类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写 @Setter 对应的注解处理器 SetterProcessor，继承刚定义的抽象类 AbstractAnnotationProcessor，重写 getSupportedAnnotationTypes 和 process 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SetterProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAnnotationProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getSupportedAnnotationTypes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Set</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Setter</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TypeElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotations</span><span class=p>,</span><span class=w> </span><span class=n>RoundEnvironment</span><span class=w> </span><span class=n>roundEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>roundEnv</span><span class=p>.</span><span class=na>getElementsAnnotatedWith</span><span class=p>(</span><span class=n>Setter</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>forEach</span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>variableHandler</span><span class=p>(</span><span class=n>item</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>::</span><span class=n>makeSetMethodDecl</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * SET 方法生成
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param classDecl    定义的类
</span></span></span><span class=line><span class=cl><span class=cm>     * @param variableDecl 定义的变量
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=o>&gt;</span><span class=w> </span><span class=nf>makeSetMethodDecl</span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=w> </span><span class=n>classDecl</span><span class=p>,</span><span class=w> </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>variableDecl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ListBuffer</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCStatement</span><span class=o>&gt;</span><span class=w> </span><span class=n>statements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ListBuffer</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 构建 this.variableName = variableName;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCExpressionStatement</span><span class=w> </span><span class=n>expressionStatement</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Exec</span><span class=p>(</span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Assign</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Ident</span><span class=p>(</span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;this&#34;</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Ident</span><span class=p>(</span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>statements</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>expressionStatement</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCBlock</span><span class=w> </span><span class=n>block</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Block</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>statements</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 生成方法参数之前，指明当前语法节点在语法树中的位置，避免出现异常 java.lang.AssertionError</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>pos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 生成入参</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>param</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>VarDef</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Modifiers</span><span class=p>(</span><span class=n>Flags</span><span class=p>.</span><span class=na>PARAMETER</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>vartype</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=o>&gt;</span><span class=w> </span><span class=n>parameters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>param</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>variableName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>variableDecl</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 构建方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCMethodDecl</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>MethodDef</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Modifiers</span><span class=p>(</span><span class=n>Flags</span><span class=p>.</span><span class=na>PUBLIC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;set&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>variableName</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>).</span><span class=na>toUpperCase</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>variableName</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>1</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Type</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Type</span><span class=p>.</span><span class=na>JCVoidType</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>parameters</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>block</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加方法到类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写 @Log 对应的注解处理器 LogProcessor，继承刚定义的抽象类 AbstractAnnotationProcessor，重写 getSupportedAnnotationTypes 和 process 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LogProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAnnotationProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Logger</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>LOGGER_FACTORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getSupportedAnnotationTypes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Set</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>TypeElement</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotations</span><span class=p>,</span><span class=w> </span><span class=n>RoundEnvironment</span><span class=w> </span><span class=n>roundEnv</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>roundEnv</span><span class=p>.</span><span class=na>getElementsAnnotatedWith</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>javacTrees</span><span class=p>.</span><span class=na>getTree</span><span class=p>(</span><span class=n>item</span><span class=p>).</span><span class=na>accept</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TreeTranslator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>visitClassDef</span><span class=p>(</span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCClassDecl</span><span class=w> </span><span class=n>classDecl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// 构建 private static final Logger log = LoggerFactory.getLogger(T.class);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>JCTree</span><span class=p>.</span><span class=na>JCVariableDecl</span><span class=w> </span><span class=n>variableDecl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>VarDef</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Modifiers</span><span class=p>(</span><span class=n>Flags</span><span class=p>.</span><span class=na>PRIVATE</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Flags</span><span class=p>.</span><span class=na>STATIC</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Flags</span><span class=p>.</span><span class=na>FINAL</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;log&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>strToJCFieldAccessChain</span><span class=p>(</span><span class=n>LOGGER</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Apply</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>List</span><span class=p>.</span><span class=na>nil</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>treeMaker</span><span class=p>.</span><span class=na>Select</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                </span><span class=n>strToJCFieldAccessChain</span><span class=p>(</span><span class=n>LOGGER_FACTORY</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                </span><span class=n>names</span><span class=p>.</span><span class=na>fromString</span><span class=p>(</span><span class=s>&#34;getLogger&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>strToJCFieldAccessChain</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=na>getSimpleName</span><span class=p>().</span><span class=na>toString</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.class&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>classDecl</span><span class=p>.</span><span class=na>defs</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>variableDecl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>super</span><span class=p>.</span><span class=na>visitClassDef</span><span class=p>(</span><span class=n>classDecl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=注册注解处理器>注册注解处理器</h3><p>要让注解处理器生效，我们需要配置 SPI 配置文件:</p><h4 id=手动配置>手动配置</h4><p>在 <strong>resource/META-INF.services</strong> 文件夹下创建一个名为 <strong>javax.annotation.processing.Processor</strong> 的文件；内容是你的注解处理器的全限定类名</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>com.brainy.nonfia.apt.processor.LogProcessor
</span></span><span class=line><span class=cl>com.brainy.nonfia.apt.processor.GetterProcessor
</span></span><span class=line><span class=cl>com.brainy.nonfia.apt.processor.SetterProcessor
</span></span></code></pre></div><p>设置编译期间禁止处理 Processor，之所以这样做是因为，如果不禁止 Processor，ServiceLoader 就会去加载刚刚设置的注解处理器，但由于此时处理器本身尚未编译，所以会抛出 class not found 异常。所以我们需要配置 <strong>-proc:none</strong> 忽略 Processor</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;compilerArgs&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg&gt;</span>-proc:none<span class=nt>&lt;/arg&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/compilerArgs&gt;</span>
</span></span></code></pre></div><h4 id=自动配置>自动配置</h4><p>@AutoService 是 Google 开源一个组件，它可以自动的帮我们生成 <strong>META-INF/services</strong> 的文件</p><p>引入依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.google.auto.service<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>auto-service<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.1.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>注解处理器上，加上注解，就会在编译期自动生成 SPI 配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AutoService</span><span class=p>(</span><span class=n>Processor</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GetterProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAnnotationProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=测试>测试</h2><p><strong>mvn clean install</strong> 打包并安装到本地Maven仓库
新建一个项目，引入上面项目的依赖，写个测试类，编译后发现，Class 文件自动生成了 getter/setter 方法且引入了日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Getter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Setter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Dog</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img src=/docs/java/standard/738504757867b1674d476019f08842fb/image.png width=905 height=681 srcset="/docs/java/standard/738504757867b1674d476019f08842fb/image_hu6efaebf98c6ab8dfb235807defdcae6f_451382_480x0_resize_box_3.png 480w, /docs/java/standard/738504757867b1674d476019f08842fb/image_hu6efaebf98c6ab8dfb235807defdcae6f_451382_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=132 data-flex-basis=318px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/java-se/>Java SE</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC-BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/docs/java/springboot/05aa2367a9817122066433ef3b31eddc/><div class=article-image><img src=https://picsum.photos/seed/05aa2367a9817122066433ef3b31eddc/800/600.webp loading=lazy data-key=docs/java/springboot/05aa2367a9817122066433ef3b31eddc data-hash=https://picsum.photos/seed/05aa2367a9817122066433ef3b31eddc/800/600.webp></div><div class=article-details><h2 class=article-title>Thymeleaf 模板引擎</h2></div></a></article><article class=has-image><a href=/docs/java/springboot/84b1fbe0502427f210938f23bc01b4ag/><div class=article-image><img src=https://picsum.photos/seed/84b1fbe0502427f210938f23bc01b4ag/800/600.webp loading=lazy data-key=docs/java/springboot/84b1fbe0502427f210938f23bc01b4ag data-hash=https://picsum.photos/seed/84b1fbe0502427f210938f23bc01b4ag/800/600.webp></div><div class=article-details><h2 class=article-title>Spring Boot Starter</h2></div></a></article><article class=has-image><a href=/docs/java/springboot/00f493c93a3f4cc188ddebd4d3ea26f2/><div class=article-image><img src=https://picsum.photos/seed/00f493c93a3f4cc188ddebd4d3ea26f2/800/600.webp loading=lazy data-key=docs/java/springboot/00f493c93a3f4cc188ddebd4d3ea26f2 data-hash=https://picsum.photos/seed/00f493c93a3f4cc188ddebd4d3ea26f2/800/600.webp></div><div class=article-details><h2 class=article-title>配置文件解析</h2></div></a></article><article class=has-image><a href=/docs/java/springboot/ab2098abbc2e93731d313aaddebe260j/><div class=article-image><img src=https://picsum.photos/seed/ab2098abbc2e93731d313aaddebe260j/800/600.webp loading=lazy data-key=docs/java/springboot/ab2098abbc2e93731d313aaddebe260j data-hash=https://picsum.photos/seed/ab2098abbc2e93731d313aaddebe260j/800/600.webp></div><div class=article-details><h2 class=article-title>Spring Boot 创建</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 nonfia</section><section class=powerby>记录编程之旅，分享代码智慧<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>